// Prisma Schema 配置文件 - SQLite 版本

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 任务表 - 用于测试和业务开发
model Task {
  id          Int       @id @default(autoincrement())
  name        String
  title       String?
  description String?
  status      String    @default("pending")
  priority    Int       @default(0)
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("tasks")
}

// 项目表 - 后续业务开发使用
model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("projects")
}

// 工作日历表 - 存储节假日、调休等例外情况（支持全局和产线专用日历）
model CalendarEvent {
  id               Int              @id @default(autoincrement())
  date             DateTime         // 日期（只存日期部分，时间为 00:00:00）
  type             String           // 类型: 'WORK'(调休上班) / 'HOLIDAY'(法定节假日) / 'REST'(其他休息)
  note             String?          // 备注说明（如：国庆节、春节调休等）
  productionLineId Int?             // 关联的产线ID（NULL表示全局配置）
  productionLine   ProductionLine?  @relation(fields: [productionLineId], references: [id], onDelete: Cascade)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @default(now()) @updatedAt

  @@unique([date, productionLineId]) // 复合唯一索引：同一天+同一产线只能有一条记录
  @@map("calendar_events")
}

// 工厂表 - 生产资源管理
model Factory {
  id              Int              @id @default(autoincrement())
  code            String?          @unique // 工厂代码（如：HJGS-01）
  name            String           // 工厂名称
  location        String?          // 位置/地址
  description     String?          // 描述
  status          Int              @default(0) /// 0: 可占用(Available), 1: 不可用(Unavailable), 2: 已占用(Occupied)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  productionLines ProductionLine[] // 关联的生产线

  @@map("factories")
}

// 生产线表 - 工厂下的生产线资源
model ProductionLine {
  id             Int             @id @default(autoincrement())
  code           String?         @unique // 产线代码（如：A-CX-01）
  name           String          // 产线名称
  type           Int             @default(0) /// 0: 部装, 1: 整装
  capacity       Int             @default(100) // 标准日产能，用于排程计算
  status         Int             @default(0) /// 0: 可占用(Available), 1: 不可用(Unavailable), 2: 已占用(Occupied)
  factoryId      Int             // 所属工厂ID
  factory        Factory         @relation(fields: [factoryId], references: [id], onDelete: Cascade)
  calendarEvents CalendarEvent[] // 该产线的专用日历事件
  stations       Station[]       // 关联的工位
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("production_lines")
}

// 工位表 - 产线下的最小生产单元
model Station {
  id               Int                 @id @default(autoincrement())
  code             String              @unique // 工位编号
  name             String              // 工位名称
  type             Int                 @default(0) // 工位类型: 0=部装, 1=总装, 2=测试
  description      String?             // 工位描述
  status           Int                 @default(0) /// 0: 可占用, 1: 不可用, 2: 已占用
  productionLineId Int?                // 关联产线ID
  productionLine   ProductionLine?     @relation(fields: [productionLineId], references: [id])
  teams            Team[]              // 关联的班组
  devices          Device[]            // 关联的设备
  capabilities     StationCapability[] // 工位能力（可处理的工序）
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@map("stations")
}

// 工位能力关联表 - 定义工位可以处理哪些标准工序
model StationCapability {
  id        Int      @id @default(autoincrement())
  stationId Int
  processId Int
  station   Station  @relation(fields: [stationId], references: [id], onDelete: Cascade)
  process   Process  @relation(fields: [processId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([stationId, processId])
  @@map("station_capabilities")
}

// 班组表 - 人员的组织单元
model Team {
  id               Int              @id @default(autoincrement())
  code             String           @unique // 班组编号
  name             String           // 班组名称
  leaderId         Int?             @unique // 班组长ID（一名人员只能担任一个班组的组长）
  leader           Staff?           @relation("TeamLeader", fields: [leaderId], references: [id])
  stationId        Int?             // 关联工位ID
  station          Station?         @relation(fields: [stationId], references: [id])
  shiftType        Int              @default(0) /// 0: 一班(08-16), 1: 二班(16-24)
  staffs           Staff[]          @relation("TeamMembers")
  capabilities     TeamCapability[] // 班组能力（可处理的工序）
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@map("teams")
}

// 班组能力关联表 - 定义班组可以处理哪些标准工序
model TeamCapability {
  id        Int      @id @default(autoincrement())
  teamId    Int
  processId Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  process   Process  @relation(fields: [processId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, processId])
  @@map("team_capabilities")
}

// 设备表 - 设备资源管理
model Device {
  id                 Int                 @id @default(autoincrement())
  code               String              @unique // 设备编号（业务主键，前缀 SB-）
  name               String              // 设备名称
  type               Int                 // 设备类型（映射自字典 ID）
  model              String?             // 规格型号
  serialNumber       String?             // 出厂序列号
  purchaseDate       DateTime?           // 采购日期
  status             Int                 @default(0) /// 0: 可占用(Assignable), 1: 不可用(Unavailable), 2: 已占用(Occupied)
  stationId          Int?                // 关联工位ID
  station            Station?            @relation(fields: [stationId], references: [id])
  maintenanceRecords MaintenanceRecord[] // 关联的维护记录
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@map("devices")
}

// 设备维护/保养记录表
model MaintenanceRecord {
  id          Int      @id @default(autoincrement())
  deviceId    Int      // 关联设备ID
  device      Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  type        String   @default("MANUAL") // 记录类型: 'MANUAL'(手动), 'AUTO'(系统自动触发)
  title       String   // 维护标题 (如: 设备报修、例行保养)
  content     String?  // 详细内容/原因
  startTime   DateTime @default(now()) // 开始时间
  endTime     DateTime? // 结束时间 (完成后填写)
  status      Int      @default(0) // 0: 进行中, 1: 已完成
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("maintenance_records")
}

// 人员表 - 人员资源管理
model Staff {
  id        Int      @id @default(autoincrement())
  staffId   String   @unique // 工号
  name      String   // 姓名
  major     Int      // 专业：0-6（映射自字典）
  level     Int      // 职级：0-4（映射自字典）
  status    Int      @default(0) /// 0: 可占用(Available), 1: 不可用(Unavailable), 2: 已占用(Occupied)
  teamId    Int?     // 所属班组ID
  team      Team?    @relation("TeamMembers", fields: [teamId], references: [id])
  ledTeam   Team?    @relation("TeamLeader")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("staffs")
}

// 产品管理 (路由产品)
model Product {
  id          Int              @id @default(autoincrement())
  code        String           @unique // 产品编号
  name        String           // 产品名称
  type        String?          // 产品类型
  model       String?          // 产品型号
  description String?          // 产品描述
  routings    ProductRouting[] // 关联的工艺路线
  orders      Order[]          // 关联的订单
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("products")
}

// 订单管理
model Order {
  id          Int      @id @default(autoincrement())
  code        String   @unique // 订单编号
  name        String   // 订单名称
  type        Int      @default(0) // 订单类型: 0=试制, 1=销售预测, 2=销售下单
  productId   Int      // 关联产品ID
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int      @default(1) // 订单数量
  deadline    DateTime // 截止时间
  status      Int      @default(0) // 0: 待排程, 1: 排程中, 2: 生产中, 3: 已完成, 4: 已推迟
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("orders")
}

// 产品工艺路线关联表
model ProductRouting {
  id        Int      @id @default(autoincrement())
  productId Int      // 产品ID
  routingId Int      // 工艺路线ID
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  routing   Routing  @relation(fields: [routingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, routingId]) // 一个产品不能重复配置同一条工艺路线
  @@map("product_routings")
}

// 工艺路线管理
model Routing {
  id          Int              @id @default(autoincrement())
  code        String           @unique // 工艺路线编号
  name        String           // 工艺路线名称
  type        Int              @default(0) // 工艺路线类型: 0=部装, 1=总装
  status      String           @default("active") // 状态
  description String?          // 描述
  processes   RoutingProcess[] // 关联的工序
  products    ProductRouting[] // 关联的产品
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("routings")
}

// 工艺路线下的工序配置
model RoutingProcess {
  id          Int      @id @default(autoincrement())
  routingId   Int      // 所属工艺路线ID
  routing     Routing  @relation(fields: [routingId], references: [id], onDelete: Cascade)
  seq         Int      // 工序号 (如: 10, 20, 30)
  code        String   // 工序编号
  name        String   // 工序名称
  description String?  // 工序描述
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("routing_processes")
}

// 标准工序管理 (工序库)
model Process {
  id               Int                 @id @default(autoincrement())
  code             String              @unique // 工序编号
  name             String              // 工序名称
  type             Int                 @default(0) // 工序类型: 0=装配, 1=检验, 2=测试
  standardTime     Int                 @default(0) // 标准工时 (小时)
  description      String?             // 工序描述
  capabilities     StationCapability[] // 拥有该能力的工位
  teamCapabilities TeamCapability[]    // 拥有该能力的班组
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@map("processes")
}

